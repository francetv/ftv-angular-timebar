/**
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 France Télévisions
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
 * documentation files (the "Software"), to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and
 * to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions of
 * the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
 * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

angular.module("ftv.components.timeBar",["ftv.components.timeBar.templates"]).directive("timeBar",["$timeout","$document","$window",function(r,t,e){return{restrict:"E",scope:{duration:"=",startDragging:"&onCursorStartDragging",stopDragging:"&onCursorStopDragging",dragging:"&onCursorDragging",jumpCursor:"&onCursorJumped"},templateUrl:"/timeBar/index.html",link:function(o,i){function n(r){c=!0,r.preventDefault(),o.startDragging(),s(r),t.on("touchmove",u),t.on("touchend",f),t.on("mousemove",u),t.on("mouseup",f)}function a(){var r=i.find(".progressBar"),t=r.offset().left,e=r.width();return{$progressBar:r,refXLeft:t,progressBarWidth:e}}function s(r){var t=a(),e=t.refXLeft,i=t.progressBarWidth,n=r.pageX;n||(n=r.originalEvent.touches[0].pageX);var s=n-e;0>s&&(s=0),s>i&&(s=i),p=o.getTimeRatioForOffsetX(s),o.dragging({time:o.convertRatioToTime(p)}),o.setBarWidthWithRatio(p)}function u(r){s(r)}function f(){c=!1,o.emitCursorJumper(p),o.stopDragging(),t.off("touchmove",u),t.off("touchend",f),t.off("mousemove",u),t.off("mouseup",f)}function g(){var t=a(),e=t.$progressBar,o=t.refXLeft,i=t.progressBarWidth;r.cancel(d),d=r(function(){e.offset().left!==o&&(o=e.offset().left,i=e.width())},500)}var m=i.find(".progressBar__bar");o.getProgressBarWidth=function(){return i.find(".progressBar").width()},o.getTimeRatioForOffsetX=function(r){var t=o.getProgressBarWidth();return r/t*100},i.bind("click",function(r){o.moveTo(r)}),o.moveTo=function(r){if("progressBar__cursor"!==r.target.className){var t=o.getTimeRatioForOffsetX(r.offsetX);o.setBarWidthWithRatio(t),o.emitCursorJumper(t)}},o.emitCursorJumper=function(r){var t=o.convertRatioToTime(r);o.jumpCursor({time:t})};var c=!1;o.moveCursor=function(r){if(!c&&"progressBar__cursor"!==r.target.className){var t=o.getTimeRatioForOffsetX(r.offsetX);o.setBarWidthWithRatio(t)}},o.setBarWidthWithTime=function(r){o.setBarWidthWithRatio(o.convertTimeToRatio(r))},o.setBarWidthWithRatio=function(r){m.css("width",r+"%")},o.convertTimeToRatio=function(r){return r/o.duration*100},o.convertRatioToTime=function(r){return r*o.duration/100},o.$watch("duration",function(){o.setBarWidthWithTime(0)}),o.$on("zoomProgressTimeChange",function(r,t){o.setBarWidthWithTime(t)}),o.setBarWidthWithTime(0),i.find(".progressBar__cursor").on("mousedown",n),i.find(".progressBar__cursor").on("touchstart",n);var d,p=0;angular.element(e).unbind("resize",g),angular.element(e).bind("resize",g)}}}]),angular.module("ftv.components.timeBar.templates",[]).run(["$templateCache",function(r){r.put("/timeBar/index.html",'<div class="progressBar"><div class="progressBar__bar"></div><div class="progressBar__cursor"><div class="progressBar__cursor__block"></div></div></div>')}]);